drop database if exists condorcet_state;
select count(*) from information_schema.schemata where schema_name = 'condorcet_state';
create database condorcet_state;
use condorcet_state;
create table role_permission (
    id int not null auto_increment,
    role ENUM('OWNER','AUDITOR','ADMIN','USER','OBSERVER','UNASSIGNED') not null,
    permission ENUM('TRANSFER_OWNER','VIEW_SECRETS','MANAGE_USERS','USE_APPLICATION','VIEW_APPLICATION') not null,
    primary key(id)
);
create table user (
    id int not null auto_increment,
    name varchar(255) not null unique,
    email varchar(255) not null unique,
    salt varchar(255) not null,
    hash varchar(255) not null,
    role ENUM('OWNER','AUDITOR','ADMIN','USER','OBSERVER','UNASSIGNED') not null,
    primary key(id)
);
create table election (
    id int not null auto_increment,
    owner_id int not null,
    foreign key fk_owner(owner_id) references user(id),
    name varchar(255) not null unique,
    end datetime(6),
    secret boolean not null,
    status ENUM('EDITING','LIVE','COMPLETE') not null,
    primary key(id)
);
create table candidate (
    id int not null auto_increment,
    election_id int not null,
    foreign key fk_election(election_id) references election(id),
    name varchar(255) not null,
    primary key(id)
);
alter table candidate add unique unique_candidate(election_id, name);
create table voter (
    id int not null auto_increment,
    election_id int not null,
    foreign key fk_election(election_id) references election(id),
    user_id int not null,
    foreign key fk_user(user_id) references user(id),
    primary key(id)
);
alter table voter add unique unique_voter(election_id, user_id);
create table ballot (
    id int not null auto_increment,
    user_id int not null,
    foreign key fk_user(user_id) references user(id),
    election_id int not null,
    foreign key fk_election(election_id) references election(id),
    confirmation varchar(255) not null,
    when_cast datetime(6) not null,
    primary key(id)
);
alter table ballot add unique unique_ballot(user_id, election_id);
create table ranking (
    id int not null auto_increment,
    ballot_id int not null,
    foreign key fk_ballot(ballot_id) references ballot(id),
    candidate_id int not null,
    foreign key fk_candidate(candidate_id) references candidate(id),
    `rank` int,
    primary key(id)
);
alter table ranking add unique unique_ranking(ballot_id, candidate_id);
create table tally (
    id int not null auto_increment,
    election_id int not null,
    foreign key fk_election(election_id) references election(id),
    report text not null,
    primary key(id)
);
alter table tally add unique unique_tally(election_id);
insert into role_permission (role, permission)
values ('OWNER', 'TRANSFER_OWNER');
insert into role_permission (role, permission)
values ('OWNER', 'VIEW_SECRETS');
insert into role_permission (role, permission)
values ('OWNER', 'MANAGE_USERS');
insert into role_permission (role, permission)
values ('OWNER', 'USE_APPLICATION');
insert into role_permission (role, permission)
values ('OWNER', 'VIEW_APPLICATION');
insert into role_permission (role, permission)
values ('AUDITOR', 'VIEW_SECRETS');
insert into role_permission (role, permission)
values ('AUDITOR', 'MANAGE_USERS');
insert into role_permission (role, permission)
values ('AUDITOR', 'USE_APPLICATION');
insert into role_permission (role, permission)
values ('AUDITOR', 'VIEW_APPLICATION');
insert into role_permission (role, permission)
values ('ADMIN', 'MANAGE_USERS');
insert into role_permission (role, permission)
values ('ADMIN', 'USE_APPLICATION');
insert into role_permission (role, permission)
values ('ADMIN', 'VIEW_APPLICATION');
insert into role_permission (role, permission)
values ('USER', 'USE_APPLICATION');
insert into role_permission (role, permission)
values ('USER', 'VIEW_APPLICATION');
insert into role_permission (role, permission)
values ('OBSERVER', 'VIEW_APPLICATION');
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'alice@email.com'
;
select count(id)
from user
;
insert into user (name,
                  email,
                  salt,
                  hash,
                  role)
values ('Alice', 'alice@email.com', '01298967-e68a-4f65-97f5-8b31b1f94a75', '5DD7625619EB3DBB0DD1BD404AA1F4BC71B9B34E1A3C1109725631BFF959C4A7', 'OWNER')
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'duplicate-email'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'alice@email.com'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Bob'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'bob@email.com'
;
select count(id)
from user
;
insert into user (name,
                  email,
                  salt,
                  hash,
                  role)
values ('Bob', 'bob@email.com', '738cdf72-3487-4f6a-a8a7-438d15f5e22d', 'AA60D57CE55FE26F5820EADA7A62A1BB91B80C667CC4E6163D19ACE32B7E2C68', 'UNASSIGNED')
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Bob'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Carol'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'carol@email.com'
;
select count(id)
from user
;
insert into user (name,
                  email,
                  salt,
                  hash,
                  role)
values ('Carol', 'carol@email.com', 'f38296e8-882d-4a22-a64c-a88660981dd6', '46C1FDAFECC2E858C91B34F75E41622DE8D70B67BABBEA32CD4F3654BA35D2F2', 'UNASSIGNED')
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Carol'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Dave'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'dave@email.com'
;
select count(id)
from user
;
insert into user (name,
                  email,
                  salt,
                  hash,
                  role)
values ('Dave', 'dave@email.com', 'cb33f280-89d0-4dc6-a01f-453aa87fcafb', 'C7362093884945D1657B57AD3ECC7DE449D60D7AA78246F31B12D579A220D2B2', 'UNASSIGNED')
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Dave'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Bob'
;
update user
set role='USER'
where name = 'Bob'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'alice@email.com'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'alice@email.com'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'alice@email.com'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'alice@email.com'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Nobody'
;
select name,
       email,
       salt,
       hash,
       role
from user
where email = 'Nobody'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Dave'
;
delete from user where name = 'Dave';
select name,
       email,
       salt,
       hash,
       role
from user
where name = 'Alice'
;
